Device =16F877A
Declare XTAL 20
ALL_DIGITAL TRUE
ON_HARDWARE_INTERRUPT GoTo I_NT'in case of interrupt originate to I_NT                               
                                                                                                                            
'''''''''''''''''''DISPLAY DECLERATIONS''''''''''''''''''''''''                                         
Output PORTD                                                  '
Declare LCD_DTPIN PORTD.4                                     '
Declare LCD_ENPIN PORTD.0                                     '
Declare LCD_RSPIN PORTD.1                                     '
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''                                                              
                                                              
'''''''''''''''''''''''''VARIABLES''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''                                                    
                                                                                                             '  
'a)for Rx                                                                                                    '
                                                                                                             '
Dim x          As Byte'used to receive frame                                                                 '                      
Dim address    As Byte'used to contain address of each received frame                                        '
Dim dataa      As Byte'used to contain the data of each frame                                                '
Dim speedlimit As Byte'used to contain the recovered data                                                    '
Dim oldspeedl  As Byte'used to save the previous recovered data                                              '                 
Dim nibble1    As Byte'used to contain the first 4 bits of data for the recovered  data                      '                                    
Dim nibble2    As Byte'used to contain the second 4 bit of the recovered data                                '                                                 
Dim n4         As Bit 'used as a flag to indicate that the nibble 4 is received                              '                                                        
Dim n5         As Bit 'used as a flag to indicate that the nibble 5 is received                              '                                                         
Dim n6         As Bit 'used as a flag to indicate that the nibble 6 is received                              '                                                          
Dim n7         As Bit 'used as a flag to indicate that the nibble 7 is received                              '
Dim fr         As Bit 'used as a flag to indicate that a full data is received                               '
Dim fr2        As Bit  'used as a flag to indicate that a full data of traffic sign 0 value is received      '                                                        
Dim RCF        As Bit 'used as a flag to indicate that defualt case MAx speed                                '                                                      
Dim CLRD       As Bit 'used as a flag to indicate that the display need to be cleared                        '                                
                                                                                                             '
'b)for transmitter                                                                                           '
                                                                                                             '
Dim state      As Byte'used to contain that indicate the state of the remote control fbs                   '                                                            '
Dim x1         As Byte'used to contain the data that that need to be transmitted to the speed monitor        '                                                             '
Dim sdataa     As Byte'used to contain the nibble of data that needs to be transmitted to the speed monitor  '
Dim sframe     As Byte'used to contain the full frame that need to be transmitted to the speed monitor       '
                                                                                                             '
'c)for motor control                                                                                         '
                                                                                                             '
Dim d          As Byte'DUTY CYCLE %                                                                          '
Dim duty       As Byte'contain the value that pwm signal is generated according to it                        '
Dim conv       As Byte'used to convert from ratio to real value                                              '
Dim ferr       As Bit 'used as a flag to indicate that the car receiver working                              '                                                              '
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''


''''''''''''''''''''SERIAL USART DECLERATIONS''''''''''''''''''''''
                                                                  '
HSERIAL_BAUD = 9600                                               '
HSERIAL_CLEAR = On    'clear the buffer before receiving          '
Symbol CREN = RCSTA.4 'Continuous Receive Enable                  '
Symbol SPEN = RCSTA.7 'Serial Port Enable                         '
Symbol TXEN = TXSTA.5 'Transmit Enable                            '
Symbol FERRR =RCSTA.2 'used to detect if buad is different        '
Symbol OERR =RCSTA.1  'used to detect if there is an interfernce  '                      
SPEN=1 'enable serial on rc6 and rc7                              '
CREN=1 'enable receiver                                           ' 
TXEN=1  'enable transmitter                                       '
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

''''''''''''''''''''''CCP DECELRATION''''''''''''''''''''''''''
                                                              '
Symbol c1 = PORTC.0'f                                        '
Symbol c2 = PORTC.3'b                                        '
Output PORTC.4 'used on first enable pin of the driver        '                                      
Output PORTC.5 'used on the second enable pin on the driver   '                                            
CCP1_PIN = PORTC.2'used to generate pwm signal on the driver  '
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

''''''''''''''''''INTERRUPT DECLERATION'''''''''''''''''''''''' 
                                                              '
Symbol PEIE = INTCON.6    'Peripheral Interrupt Enable        '
Symbol GIE = INTCON.7     'Global Interrupt Enable            '
Symbol PBPU=OPTION_REG.7  'portb pull up                      '              
PBPU=0 'enable interrnal pullup resistor on portB             '                                          
GIE = 1 'enable the global interrupt                          '                            
PEIE = 1 'enable the periphiral interrupts                    '                                 
                                                              '
'a)portb interrupt                                            '
Symbol INTF = INTCON.1 ' RB0 External Interrupt Flag          '
Symbol INTE = INTCON.4 ' RB0 External Interrupt Enable        '
INTE=1 'enalbe rb0 interrupt                                  '                     
OPTION_REG.6=0 'on rissing edge 1                             '
                                                              '
'b)receive interrupt                                          '
                                                              '
Symbol RCIE= PIE1.5 'interrupt enable of receiver             '                             
Symbol RCIF= PIR1.5  'interrupt flag of receiver              '                            
RCIE=1 'enable interrupt on receiver                          '
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

''''''''''''''''''''CLEARING PORTS AND REGISTERS''''''''''''''' 
                                                              '
 n4 =0                                                        '
 n5 =0                                                        '
 n6 =0                                                        '
 n7 =0                                                        '
 RCF=0                                                        '
 fr =0                                                        '
 Print Cls                                                    '
                                                              '
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
 
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''main program''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

If RCF = 0 Then ''''''''''''''''''''''''''''''''''TO GIVE MAX SPEED IN CASE OF DEFUALT CASE''''''''''''''''''''''''''''''
                                                                                                                        '
speedlimit=100                                                                                                          '
                                                                                                                        '
oldspeedl=100                                                                                                           '
                                                                                                                        '
Print At 1,1,MAX SPEED 100                                                                                           '
                                                                                                                        '
CLRD=1                                                                                                                  '
                                                                                                                        '
INTF=1                                                                                                                  ' 
                                                                                                                        '
EndIf''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

remote''''''''''''''''''''''''''''''''''VEHICHLE REMOTE CAR SECTION TO DETECT MOVING STATE''''''''''''''''''''''''''''''
                                                                                                                         '
Input PORTC.0                                                                                                            '
                                                                                                                         '
Input PORTC.3                                                                                                            '
                                                                                                                         '
PORTC.0=0                                                                                                                '
                                                                                                                         '
PORTC.3=0                                                                                                                '
                                                                                                                         '
If c1=1 And c2=0  Then'forward case                                                                                      '
                                                                                                                         '
Print At 2,16,F                                                                                                        '
                                                                                                                         '
PORTC.4=1'forward pin                                                                                                    '
                                                                                                                         '
PORTC.5=0'backward pin                                                                                                   '
                                                                                                                         '
GoTo motor                                                                                                               '
                                                                                                                         '
ElseIf c1=0 And c2=1 Then'backward case                                                                                  '
                                                                                                                         '
Print At 2,16,B                                                                                                        '
                                                                                                                         '
PORTC.4=0'forward pin                                                                                                    '
                                                                                                                         '
PORTC.5=1'backward pin                                                                                                   '
                                                                                                                         '
GoTo motor                                                                                                               '
                                                                                                                         '
ElseIf c1=1 And c2 =1 Then'error case                                                                                    '
                                                                                                                         '
Print At 1,1 ,err Remote                                                                                               '
                                                                                                                         '
PORTC.4=0'forward pin                                                                                                    '
                                                                                                                         '
PORTC.5=0'backward pin                                                                                                   '
                                                                                                                         '
ferr=1                                                                                                                   '
                                                                                                                         '
EndIf                                                                                                                    '
                                                                                                                         '
GoTo remote'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''     

motor'''''''''''''''''''''''''''''''''''''''MOTOR CONTROLS USING PWM''''''''''''''''''''''''''''''''''''''''''''''''''''''
                                                                                                                          '
If ferr=1  Then'''''''''''''''''''''used to clear display and redisplay it correctly'''''''''''''''                       '                                                                                   '
                                                                                                  '                       '
Print Cls                                                                                         '                       '
                                                                                                  '                       '
ferr=0                                                                                            '                       '
                                                                                                  '                       '
Print At 1,1,LV  ,Dec speedlimit,                                                            '                       '
                                                                                                  '                       '
Print At 1,14,D,BIN x.7                                                                        '                       '
                                                                                                  '                       '
EndIf''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''                       '                                                                                             '
                                                                                                                          '
conv=((255speedlimit)(100))                                                                                             '
                                                                                                                          '
HPWM 1,conv,2000                                                                                                          '
                                                                                                                          '
Print At 2,1,d,Dec speedlimit,                                                                                       '
                                                                                                                          '
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

x1= speedlimit ;data1(speedl)'''''''''''''''''''''''''TRANSMISION TO SPEED MONITOR SECTION''''''''''''''''''''''''''''''''
                                                                                                                         '
sdataa = x1                                                                                                              '
                                                                                                                         '
;data and %00001111                                                                                                      '
ClearBit  sdataa,7                                                                                                       '
ClearBit  sdataa,6                                                                                                       '
ClearBit  sdataa,5                                                                                                       '
ClearBit  sdataa,4                                                                                                       '
                                                                                                                         '
sframe =128'%10000000                                                                                                    '
                                                                                                                         '
sframe =sframe+ sdataa                                                                                                   '
                                                                                                                         ' 
HRSOut sframe                                                                                                            '
                                                                                                                         '
sdataa = x1                                                                                                              '
                                                                                                                         '
;data and %11110000                                                                                                      '
ClearBit  sdataa,0                                                                                                       '
ClearBit  sdataa,1                                                                                                       '
ClearBit  sdataa,2                                                                                                       '
ClearBit  sdataa,3                                                                                                       '
                                                                                                                         '
sdataa=sdataa  16  ;swap data from HIGHER nibble to LOWER                                                               '
                                                                                                                         '
sframe =144'%10010000                                                                                                    '
                                                                                                                         '
sframe = sframe  + sdataa                                                                                                '
                                                                                                                         '
HRSOut sframe                                                                                                            '
                                                                                                                         '
If c1=0 And c2=0 Then                                                                                                    '
                                                                                                                         '
state =161'%10100001       'Stop                                                                                         '
                                                                                                                         '
ElseIf c1=1 And c2=0 Then                                                                                                '
                                                                                                                         '
state =162'%10100010       'forward                                                                                      '
                                                                                                                         '
ElseIf c1=0 And c2=1 Then                                                                                                '
                                                                                                                         '
state =163'%10100011       'forward                                                                                      '
                                                                                                                         '
EndIf                                                                                                                    '
                                                                                                                         '
HRSOut state                                                                                                             '
                                                                                                                         '
GoTo remote'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

I_NT''''''''''''''''''''''''''''''''''''''''''''''''''''''''INTERRUPT SECTION''''''''''''''''''''''''''''''''''''''''''''
                                                                                                                         '
If RCIF = 1 Then GoTo R_X                                                                                                '
                                                                                                                         '
If INTF=1 Then GoTo st_op                                                                                                '
                                                                                                                         '
Context Restore'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

R_X''''''''''''''''''''''''''''''''''''''''''''''''''''''''INTERRUPT WHILE RECEIVING'''''''''''''''''''''''''''''''''''''''''''''
                                                                                                                                 '
x = HRSin   'Receive a byte serially into x                                                                                      '
                                                                                                                                 '
fr=0                                                                                                                             '
                                                                                                                                 '
                                                                                                                                 '
                                                                                                                                 '
If c1=0 And c2=0 Then''''''''''''''''''''''''''''' TO STOP CAR IN CASE OF EXCUTING THE RECEIVE INTERRUPT''''''''''''''''''       '                                                                                             '
                                                                                                                         '       '
INTF=0                                                                                                                   '       '
                                                                                                                         '       '
Print At 2,16,S                                                                                                        '       '
                                                                                                                         '       '
PORTC.4=0'forward pin                                                                                                    '       '
                                                                                                                         '       '
PORTC.5=0'backward pin                                                                                                   '       '
                                                                                                                         '       '
PORTC.4=0'forward pin                                                                                                    '       '
                                                                                                                         '       '
PORTC.5=0'backward pin                                                                                                   '       '
EndIf'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''       '
                                                                                                                                 '
                                                                                                                                 '
If ferr=1 Or CLRD=1 Then''''''''used to clear the display in case of error occured or defualt case max speed''''''               '                                                                                 '
                                                                                                                 '               '
Print Cls                                                                                                        '               '
                                                                                                                 '               '
ferr=0                                                                                                           '               '
                                                                                                                 '               '
CLRD=0                                                                                                           '               '
                                                                                                                 '               '
Print At 2,1,d,Dec duty,                                                                                    '               '
                                                                                                                 '               '
EndIf                                                                                                            '               '
                                                                                                                 '               '
RCF=1'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''               '                                                                                                     
                                                                                                                                 '
'If FERRR=1 Or OERR=1 Then ERRR=1  GoTo SKIPP  'used to check if any error in received data optional                            '
                                                                                                                                 '
address = x ;ADDRESS and 240'''''''''''''''''''recover data section from each frame'''''''''''''''''''''''''''''''''''''         '                                                                                    
                                                                                                                       '         '
ClearBit  address,0                                                                                                    '         '                                 
ClearBit  address,1                                                                                                    '         '                                                                                   
ClearBit  address,2                                                                                                    '         '                                                                                   
ClearBit  address,3                                                                                                    '         '
                                                                                                                       '         '
dataa = x  ;data and 15                                                                                                '         '                                                                                                                  
ClearBit  dataa,7                                                                                                      '         '                                                                                                                  
ClearBit  dataa,6                                                                                                      '         '                                                                                                                  
ClearBit  dataa,5                                                                                                      '         '                                                                                                                  
ClearBit  dataa,4                                                                                                      '         '
                                                                                                                       '         '
Select address                                                                                                         '         '
                                                                                                                       '         '
Case 64  '01000000                                                                                                     '         '
                                                                                                                       '         '
n4=1                                                                                                                   '         '                                                                                                                  
fr=0                                                                                                                   '         '                                                                                                                  
nibble1=dataa                                                                                                          '         '
                                                                                                                       '         '
Case 80  '01010000                                                                                                     '         '
                                                                                                                       '         '
n5=1                                                                                                                   '         '                                                                                                                  
fr=0                                                                                                                   '         '                                                                                                                  
nibble2=dataa 16                                                                                                      '         '
                                                                                                                       '         '
Case  96 '01010000                                                                                                     '         '
                                                                                                                       '         '
n6=1                                                                                                                   '         '                                                                                                                
nibble1=dataa                                                                                                          '         '
fr2=0                                                                                                                  '         '
                                                                                                                       '         '
Case 112   '01110000                                                                                                   '         '                                                                                                                  
                                                                                                                       '         '
n7=1                                                                                                                   '         '
fr2=0                                                                                                                  '         '
nibble2=dataa 16                                                                                                      '         '
                                                                                                                       '         '
Case Else                                                                                                              '         '
                                                                                                                       '         '
If address.7=1 Then   ' address = 128 Or address =144 Or address =160 Or address = 176 Then                            '         '
                                                                                                                       '         '
speedlimit = oldspeedl                                                                                                 '         '
                                                                                                                       '         '
Context Restore                                                                                                        '         '
                                                                                                                       '         '
EndIf                                                                                                                  '         '
                                                                                                                       '         '
End Select                                                                                                             '         '
                                                                                                                       '         '
If n4=1 And n5=1 Then                                                                                                  '         '
                                                                                                                       '         '
fr=1                                                                                                                   '         '
                                                                                                                       '         '
speedlimit =nibble1 + nibble2                                                                                          '         '
                                                                                                                       '         '
n4=0                                                                                                                   '         '
                                                                                                                       '         '
n5=0                                                                                                                   '         '
                                                                                                                       '         '
oldspeedl=speedlimit                                                                                                   '         '
                                                                                                                       '         '
Print At 1,1,LV  ,Dec speedlimit,                                                                                 '         '
                                                                                                                       '         '
EndIf                                                                                                                  '         '
                                                                                                                       '         '
If n6 =1 And n7=1 Then                                                                                                 '         '
                                                                                                                       '         '
fr2=1                                                                                                                  '         '
                                                                                                                       '         '
speedlimit =nibble1 + nibble2                                                                                          '         '
                                                                                                                       '         '
n6=0                                                                                                                   '         '
                                                                                                                       '         '                                                                                                                 
n7=0                                                                                                                   '         '
                                                                                                                       '         '
oldspeedl=speedlimit                                                                                                   '         '
                                                                                                                       '         '
Print At 1,1,LV  ,Dec speedlimit,                                                                                 '         '
                                                                                                                       '         '
EndIf                                                                                                                  '         '
                                                                                                                       '         '                                                                                                                  
Print At 1,14,D,BIN x.7''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''         '                                                                                      
                                                                                                                                 '
                                                                                                                                 '
If fr=1 Or fr2=1 Then''''' recheck the state of remote control and regenrate the pwm signal according to the new data'''''''     '                                                                                                        
                                                                                                                           '     '
If c1=1 And c2=0  Then                                                                                                     '     '
                                                                                                                           '     '
Print At 2,16,F                                                                                                          '     '
                                                                                                                           '     '
PORTC.4=1'forward pin                                                                                                      '     '
                                                                                                                           '     '
PORTC.5=0'backward pin                                                                                                     '     '
                                                                                                                           '     '
GoTo motor1                                                                                                                '     '
                                                                                                                           '     '
ElseIf c1=0 And c2=1 Then                                                                                                  '     '
                                                                                                                           '     '
Print At 2,16,B                                                                                                          '     '
                                                                                                                           '     '
PORTC.4=0'forward pin                                                                                                      '     '
                                                                                                                           '     '
PORTC.5=1'backward pin                                                                                                     '     '
                                                                                                                           '     '
GoTo motor1                                                                                                                '     '
                                                                                                                           '     '
ElseIf c1=0 And c2=0 Then                                                                                                  '     '
                                                                                                                           '     '
Print At 2,16,S                                                                                                          '     '
                                                                                                                           '     '
PORTC.4=0'forward pin                                                                                                      '     '
                                                                                                                           '     '
PORTC.5=0'backward pin                                                                                                     '     '
                                                                                                                           '     '
EndIf                                                                                                                      '     '
                                                                                                                           '     '
                                                                                                                           '     '
motor1                                                                                                                    '     '
                                                                                                                           '     '
conv=((255speedlimit)(100))                                                                                              '     '
                                                                                                                           '     '
HPWM 1,conv,2000                                                                                                           '     '
                                                                                                                           '     '
Print At 2,1,d,Dec speedlimit,                                                                                        '     '
                                                                                                                           '     '
                                                                                                                           '     '
EndIf'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''     '
                                                                                                                                 '
'SKIPP                                                                                                                          '
                                                                                                                                 '
'If ERRR=1 Then speedlimit = oldspeedlERRR=0 'optional                                                                          '                        
                                                                                                                                 '
x1= speedlimit ;data1(speedl)'''''RETRANSMISION SECTION IN CASE TRANSMISION IS INTERRUPTED BY THE RECEIVE INTERRUPT''''''''''    '
                                                                                                                            '    '
sdataa = x1                                                                                                                 '    '
                                                                                                                            '    '
;data and %00001111                                                                                                         '    '
ClearBit  sdataa,7                                                                                                          '    '
ClearBit  sdataa,6                                                                                                          '    '
ClearBit  sdataa,5                                                                                                          '    '
ClearBit  sdataa,4                                                                                                          '    '
                                                                                                                            '    '
sframe =128'%10000000                                                                                                       '    '
                                                                                                                            '    '
sframe =sframe+ sdataa                                                                                                      '    '
                                                                                                                            '    '
HRSOut sframe                                                                                                               '    '
                                                                                                                            '    '
sdataa = x1                                                                                                                 '    '
                                                                                                                            '    '
';data and %11110000                                                                                                        '    '
ClearBit  sdataa,0                                                                                                          '    '
ClearBit  sdataa,1                                                                                                          '    '
ClearBit  sdataa,2                                                                                                          '    '
ClearBit  sdataa,3                                                                                                          '    '
                                                                                                                            '    '
sdataa=sdataa  16  ;swap data from HIGHER nibble to LOWER                                                                  '    '
                                                                                                                            '    '
sframe =144'%10010000                                                                                                       '    '
                                                                                                                            '    '
sframe = sframe  + sdataa                                                                                                   '    '
                                                                                                                            '    '
HRSOut sframe                                                                                                               '    '
                                                                                                                            '    '
                                                                                                                            '    '
If c1=0 And c2=0 Then''''''''used to send the state of remote control to speed monitor''''''''''''''''''''''''''''''''''''' '    '                                                                                                '
                                                                                                                          ' '    '
state =161'%10100001       'Stop                                                                                          ' '    '     
                                                                                                                          ' '    '    
ElseIf c1=1 And c2=0 Then                                                                                                 ' '    '   
                                                                                                                          ' '    '  
state =162'%10100010       'forward                                                                                       ' '    ' 
                                                                                                                          ' '    '
ElseIf c1=0 And c2=1 Then                                                                                                 ' '    '
                                                                                                                          ' '    '
state =163'%10100011       'forward                                                                                       ' '    '
                                                                                                                          ' '    '
EndIf                                                                                                                     ' '    '
                                                                                                                          ' '    '
HRSOut state''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''' '    '                                                                                                       
                                                                                                                            '    '                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''    '
                                                                                                                                 '
RCIF=0                                                                                                                           '
                                                                                                                                 '
Context Restore'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
                                                                                                                                                                                                                                                                                                                                                                            
st_op''''''''''''''''''''''''''''''''''''''''''''''''''''''''''INTERRUPT USING RB0'''''''''''''''''''''''''''''''''''''''''
                                                                                                                           '
c1=0                                                                                                                       '
                                                                                                                           '
c2=0                                                                                                                       '
                                                                                                                           '
Print Cls'clear display each time interrupt occurs                                                                         '
                                                                                                                           '
Wait'''''''''''''''''''''''wait till the  c1 and c2 are different from 0-0''''''''''''''''''''                            '
                                                                                              '                            '
If RCIF =1 Then x=HRSin                                                                       '                            '
                                                                                              '                            '
                                                                                              '                            '
If CLRD=1 Then                                                                                '                            '
                                                                                              '                            '
Print At 1,1,MAX SPEED 100                                                                 '                            '
                                                                                              '                            '
Else                                                                                          '                            '
                                                                                              '                            '
Print At 1,1,LV  ,Dec speedlimit,                                                        '                            '
                                                                                              '                            ' 
Print At 1,14,D,BIN x.7                                                                    '                            '
                                                                                              '                            '
EndIf                                                                                         '                            ' 
                                                                                              '                            '
If c1=0 And c2=0 Then  'goto stop in case controller gives 0v on pin 3 and pin 4              '                            '                                                                                                                                                                                                                                                      
                                                                                              '                            '
duty =0                                                                                       '                            '
                                                                                              '                            '
'Print At 2,1 ,d,Dec duty,                                                               '                            ' 
                                                                                              '                            '
Print At 2,16,S                                                                             '                            '
                                                                                              '                            '
PORTC.4=0'forward pin                                                                         '                            '
                                                                                              '                            '
PORTC.5=0'backward pin                                                                        '                            '
                                                                                              '                            '
PORTC.4=0                                                                                     '                            '
                                                                                              '                            '
PORTC.5=0                                                                                     '                            '
Print At 2,1,d,Dec duty,                                                                 '                            '
HPWM 1,0,2000                                                                                 '                            '                       
HPWM 1,0,2000''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''                            '                                                   
                                                                                                                           '
                                                                                                                           '                                                                                                                           
If RCIF =1 Then''''''''''RECEIVING AGAIN IN CASE OF STUCK IN THE SUBROUTINE OF THE RB0 INTERRUPT''''''''                   '                                                                                         
                                                                                                       '                   '
'If FERRR=1 Or OERR=1 Then ERRR=1  GoTo SKIPP2                                                        '                   '
                                                                                                       '                   '
RCF=1                                                                                                  '                   '
                                                                                                       '                   '                                                                                    
address = x ;ADDRESS and 240                                                                           '                   '
                                                                                                       '                   '
ClearBit  address,0                                                                                    '                   '
                                                                                                       '                   '
ClearBit  address,1                                                                                    '                   '
                                                                                                       '                   '
ClearBit  address,2                                                                                    '                   '
                                                                                                       '                   '
ClearBit  address,3                                                                                    '                   '
                                                                                                       '                   '
dataa = x  ;data and 15                                                                                '                   '
                                                                                                       '                   '
ClearBit  dataa,7                                                                                      '                   '
                                                                                                       '                   '
ClearBit  dataa,6                                                                                      '                   '
                                                                                                       '                   '
ClearBit  dataa,5                                                                                      '                   '
                                                                                                       '                   '
ClearBit  dataa,4                                                                                      '                   '
                                                                                                       '                   '
Select address                                                                                         '                   '
                                                                                                       '                   '
Case 64  '01000000                                                                                     '                   '
                                                                                                       '                   '
n4=1                                                                                                   '                   '
                                                                                                       '                   '
fr=0                                                                                                   '                   '
                                                                                                       '                   '
nibble1=dataa                                                                                          '                   '
                                                                                                       '                   '
Case 80  '01010000                                                                                     '                   '
                                                                                                       '                   '
n5=1                                                                                                   '                   '
                                                                                                       '                   '
fr=0                                                                                                   '                   '
                                                                                                       '                   '
nibble2=dataa 16                                                                                      '                   '
                                                                                                       '                   '
Case  96 '01010000                                                                                     '                   '
                                                                                                       '                   '
n6=1                                                                                                   '                   '
                                                                                                       '                   '
nibble1=dataa                                                                                          '                   '
                                                                                                       '                   '
Case 112   '01110000                                                                                   '                   '
                                                                                                       '                   '
n7=1                                                                                                   '                   '
                                                                                                       '                   '
nibble2=dataa 16                                                                                      '                   '
                                                                                                       '                   '
Case Else                                                                                              '                   '
                                                                                                       '                   '
If address.7=1 Then   ' address = 128 Or address =144 Or address =160 Or address = 176 Then            '                   '
                                                                                                       '                   '
speedlimit = oldspeedl                                                                                 '                   '
                                                                                                       '                   '
Context Restore                                                                                        '                   '
                                                                                                       '                   '
EndIf                                                                                                  '                   '
                                                                                                       '                   '
End Select                                                                                             '                   '
                                                                                                       '                   '
If n4=1 And n5=1 Then                                                                                  '                   '
                                                                                                       '                   '                                                                '
                                                                                                       '                   '
fr=1                                                                                                   '                   '
                                                                                                       '                   '
speedlimit =nibble1 + nibble2                                                                          '                   '
                                                                                                       '                   '
n4=0                                                                                                   '                   '
                                                                                                       '                   '
n5=0                                                                                                   '                   '
                                                                                                       '                   '
oldspeedl=speedlimit                                                                                   '                   '
                                                                                                       '                   '
Print At 1,1,LV  ,Dec speedlimit,                                                                 '                   '
                                                                                                       '                   '
EndIf                                                                                                  '                   '
                                                                                                       '                   '
If n6 =1 And n7=1 Then                                                                                 '                   '
                                                                                                       '                   '
speedlimit =nibble1 + nibble2                                                                          '                   '
                                                                                                       '                   '
n6=0                                                                                                   '                   '
                                                                                                       '                   '
n7=0                                                                                                   '                   '
                                                                                                       '                   '
oldspeedl=speedlimit                                                                                   '                   '
                                                                                                       '                   '
Print At 1,1,LV  ,Dec speedlimit,                                                                 '                   '
                                                                                                       '                   '
EndIf                                                                                                  '                   '
                                                                                                       '                   '
Print At 1,14,D,BIN x.7                                                                             '                   '
                                                                                                       '                   '
'SKIPP2                                                                                               '                   '
                                                                                                       '                   '                                                                                    '
RCIF = 0                                                                                               '                   '
                                                                                                       '                   '
EndIf'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''                   '                                                                                                   '
                                                                                                                           '
                                                                                                                           '
x1= speedlimit ;data1(speedl)'''''''''RETRANSMISION IN CASE IF STUCK IN THE SUBROUTINE OF THE RB0 INTERRUPT'''''''''''     '                                                                                         '
                                                                                                                     '     '
sdataa = x1                                                                                                          '     '
                                                                                                                     '     '
;data and %00001111                                                                                                  '     '
ClearBit  sdataa,7                                                                                                   '     '
ClearBit  sdataa,6                                                                                                   '     '
ClearBit  sdataa,5                                                                                                   '     '
ClearBit  sdataa,4                                                                                                   '     '
                                                                                                                     '     '
sframe =128'%10000000                                                                                                '     '
                                                                                                                     '     '
sframe =sframe+ sdataa                                                                                               '     '
                                                                                                                     '     '
HRSOut sframe                                                                                                        '     '
                                                                                                                     '     '
sdataa = x1                                                                                                          '     '
                                                                                                                     '     '
;data and %11110000                                                                                                  '     '
ClearBit  sdataa,0                                                                                                   '     ' 
ClearBit  sdataa,1                                                                                                   '     '
ClearBit  sdataa,2                                                                                                   '     '
ClearBit  sdataa,3                                                                                                   '     '
                                                                                                                     '     '
sdataa=sdataa  16  ;swap data from HIGHER nibble to LOWER                                                           '     '
                                                                                                                     '     '
sframe =144'%10010000                                                                                                '     '
                                                                                                                     '     '
sframe = sframe  + sdataa                                                                                            '     '
                                                                                                                     '     '
HRSOut sframe                                                                                                        '     '
                                                                                                                     '     '
state =161'%10100001       'Stop                                                                                     '     '
                                                                                                                     '     '
HRSOut state                                                                                                         '     '
                                                                                                                     '     '
GoTo Wait                                                                                                            '     '
                                                                                                                     '     '
EndIf                                                                                                                '     '                                                                                                                      
                                                                                                                     '     '
INTF=0''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''     '                                                                                                                '
                                                                                                                           '
Context Restore                                                                                                            '
                                                                                                                           '
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''                                                                                                                           
End                                                                                                                                            
